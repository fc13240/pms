<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.lotut.pms.dao.mapper.PatentDocWorkflowHistoryMapper">
  		<resultMap type="PatentDocWorkflowHistory" id="PatentDocWorkflowHistoryMap">
  			<id property="historyId" column="history_id"/>
  			<result property="patentDocId"  column="patent_doc_id" />
  			<result property="userId"  column="user_id" />
  			<result property="userName"  column="user_name" />
  			<result property="actionTime"  column="action_time" />
  			<association property="patentDocWorkflowAction" javaType="PatentDocWorkflowAction">
				<id property="actionId" column="action_id"/>
				<result property="actionTypeDesc" column="action_type_desc"/>
			</association>
  			<collection property="shareUsers" resultMap="com.lotut.pms.dao.mapper.UserMapper.UserResultMap"/>
  		</resultMap>
  
  	
  	
  	<insert id="insertWorkflowTargets" parameterType="list" >
  		replace into patent_doc_workflow_target(history,target,patent_doc)
  		values
  		<foreach item="patentDocWorkflowTargetRecord" collection="list" separator=",">
			(#{patentDocWorkflowTargetRecord.history},#{patentDocWorkflowTargetRecord.target}, #{patentDocWorkflowTargetRecord.patentDoc})
		</foreach>
  	</insert>
  
	<insert id="insertHistories"  parameterType="list" useGeneratedKeys="true" keyProperty="historyId">
		replace into patent_doc_workflow_history(patent_doc_id,user_id,ACTION,action_time)
		values
		<foreach item="patentDocWorkflowHistoryRecord" collection="list" separator=",">
			(#{patentDocWorkflowHistoryRecord.patentDocId},#{patentDocWorkflowHistoryRecord.userId}, #{patentDocWorkflowHistoryRecord.action},now())
		</foreach>
	</insert>
	
	<select id="getPatentDocWorkflowHistoryByUserAndAction" resultMap="PatentDocWorkflowHistoryMap">
		select history_id,patent_doc_id,user_id,ACTION,action_time from patent_doc_workflow_history  where 
		user_id =(#{userId}) and ACTION= (#{action})
	
	</select>
	
	<select id="getHistoryBy">
		 SELECT h.history_id,h.patent_doc_id , u.username, a.action_type_desc, h.action_time,s.share_to FROM patent_doc_workflow_history h 
		 JOIN users u ON h.user_id=u.user_id JOIN patent_doc_workflow_action a ON h.ACTION = a.action_id 
      	join share_patent_docs s on h.user_id = s.share_by and h.patent_doc_id = s.patent_doc where patent_doc_id =(#{patentDocId});
	</select>
	
<!-- 	<select id="getHistoryIdbyPatentDocId" parameterType="int">
		select history_id from patent_doc_workflow_history  where patent_doc_id = (#{patentDocId});
		
	</select>
	 -->
	
	<insert id="insertSharePatentDocs" parameterType="list">
		replace into share_patent_docs(patent_doc, share_by, share_to) 
		values
		<foreach item="shareRecord" collection="list" separator=",">
			(#{shareRecord.patentDoc}, #{shareRecord.shareBy}, #{shareRecord.shareTo})
		</foreach>
	</insert>
	
	 </mapper>